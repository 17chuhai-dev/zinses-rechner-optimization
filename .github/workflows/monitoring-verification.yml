name: Monitoring and Alerting Verification

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š8ç‚¹éªŒè¯ç›‘æ§ç³»ç»Ÿ
    - cron: '0 8 * * *'
    # æ¯å‘¨ä¸€è¿›è¡Œå…¨é¢ç›‘æ§éªŒè¯
    - cron: '0 6 * * 1'
  
  workflow_dispatch:
    inputs:
      verification_type:
        description: 'Type of monitoring verification'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - health-only
          - alerts-only
          - dashboard-only
          - performance-only
      
      target_environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development
      
      send_test_alerts:
        description: 'Send test alerts to notification channels'
        required: false
        default: false
        type: boolean

  push:
    branches: [ main ]
    paths:
      - 'monitoring/**'
      - '.github/workflows/monitoring-verification.yml'
      - 'backend/app/api/test/monitoring.py'

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # å¥åº·æ£€æŸ¥éªŒè¯
  health-check-verification:
    name: ğŸ¥ Health Check Verification
    runs-on: ubuntu-latest
    if: github.event.inputs.verification_type != 'alerts-only' && github.event.inputs.verification_type != 'dashboard-only'
    
    outputs:
      api-health: ${{ steps.health-check.outputs.api-health }}
      frontend-health: ${{ steps.health-check.outputs.frontend-health }}
      response-time: ${{ steps.health-check.outputs.response-time }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set target URLs
        id: set-urls
        run: |
          if [ "${{ github.event.inputs.target_environment }}" = "production" ]; then
            echo "api-url=https://api.zinses-rechner.de" >> $GITHUB_OUTPUT
            echo "frontend-url=https://zinses-rechner.de" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.target_environment }}" = "staging" ]; then
            echo "api-url=https://staging-api.zinses-rechner.de" >> $GITHUB_OUTPUT
            echo "frontend-url=https://staging.zinses-rechner.de" >> $GITHUB_OUTPUT
          else
            echo "api-url=http://localhost:8000" >> $GITHUB_OUTPUT
            echo "frontend-url=http://localhost:5173" >> $GITHUB_OUTPUT
          fi

      - name: Verify API health endpoint
        id: health-check
        run: |
          echo "ğŸ¥ éªŒè¯APIå¥åº·æ£€æŸ¥ç«¯ç‚¹..."
          
          API_URL="${{ steps.set-urls.outputs.api-url }}"
          FRONTEND_URL="${{ steps.set-urls.outputs.frontend-url }}"
          
          # æµ‹è¯•APIå¥åº·æ£€æŸ¥
          START_TIME=$(date +%s%3N)
          API_RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" "$API_URL/health" 2>/dev/null)
          END_TIME=$(date +%s%3N)
          
          API_STATUS=$(echo "$API_RESPONSE" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
          RESPONSE_TIME=$((END_TIME - START_TIME))
          
          echo "APIçŠ¶æ€ç : $API_STATUS"
          echo "å“åº”æ—¶é—´: ${RESPONSE_TIME}ms"
          
          if [ "$API_STATUS" = "200" ]; then
            echo "api-health=healthy" >> $GITHUB_OUTPUT
            echo "âœ… APIå¥åº·æ£€æŸ¥æ­£å¸¸"
          else
            echo "api-health=unhealthy" >> $GITHUB_OUTPUT
            echo "::error::APIå¥åº·æ£€æŸ¥å¤±è´¥: HTTP $API_STATUS"
            exit 1
          fi
          
          echo "response-time=$RESPONSE_TIME" >> $GITHUB_OUTPUT
          
          # æµ‹è¯•å‰ç«¯å¯ç”¨æ€§
          FRONTEND_RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" "$FRONTEND_URL" 2>/dev/null)
          FRONTEND_STATUS=$(echo "$FRONTEND_RESPONSE" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
          
          if [ "$FRONTEND_STATUS" = "200" ]; then
            echo "frontend-health=healthy" >> $GITHUB_OUTPUT
            echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
          else
            echo "frontend-health=unhealthy" >> $GITHUB_OUTPUT
            echo "::error::å‰ç«¯æœåŠ¡å¼‚å¸¸: HTTP $FRONTEND_STATUS"
          fi

      - name: Test API functionality
        run: |
          echo "ğŸ”§ æµ‹è¯•APIæ ¸å¿ƒåŠŸèƒ½..."
          
          API_URL="${{ steps.set-urls.outputs.api-url }}"
          
          # æµ‹è¯•è®¡ç®—API
          CALC_RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" \
            -X POST "$API_URL/api/v1/calculate/compound-interest" \
            -H "Content-Type: application/json" \
            -d '{"principal": 10000, "annual_rate": 4.0, "years": 10, "monthly_payment": 500, "compound_frequency": "monthly"}' \
            2>/dev/null)
          
          CALC_STATUS=$(echo "$CALC_RESPONSE" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
          
          if [ "$CALC_STATUS" = "200" ]; then
            echo "âœ… è®¡ç®—APIåŠŸèƒ½æ­£å¸¸"
            
            # éªŒè¯å“åº”æ ¼å¼
            CALC_BODY=$(echo "$CALC_RESPONSE" | sed 's/HTTPSTATUS:[0-9]*$//')
            if echo "$CALC_BODY" | jq -e '.final_amount' >/dev/null 2>&1; then
              echo "âœ… è®¡ç®—ç»“æœæ ¼å¼æ­£ç¡®"
            else
              echo "::warning::è®¡ç®—ç»“æœæ ¼å¼å¯èƒ½å¼‚å¸¸"
            fi
          else
            echo "::error::è®¡ç®—APIåŠŸèƒ½å¼‚å¸¸: HTTP $CALC_STATUS"
          fi

  # å‘Šè­¦è§„åˆ™éªŒè¯
  alert-rules-verification:
    name: ğŸš¨ Alert Rules Verification
    runs-on: ubuntu-latest
    needs: health-check-verification
    if: github.event.inputs.verification_type != 'health-only' && github.event.inputs.verification_type != 'dashboard-only'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test alert triggers
        run: |
          echo "ğŸš¨ æµ‹è¯•å‘Šè­¦è§„åˆ™è§¦å‘..."
          
          API_URL="${{ needs.health-check-verification.outputs.api-url || 'https://api.zinses-rechner.de' }}"
          
          # æµ‹è¯•CPUå‘Šè­¦
          echo "æµ‹è¯•CPUä½¿ç”¨ç‡å‘Šè­¦..."
          CPU_ALERT=$(curl -s -w "HTTPSTATUS:%{http_code}" \
            -X POST "$API_URL/test/trigger-alert" \
            -H "Content-Type: application/json" \
            -d '{"metric": "cpu_usage", "value": 95, "test": true}' \
            2>/dev/null || echo "HTTPSTATUS:404")
          
          CPU_STATUS=$(echo "$CPU_ALERT" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
          
          if [ "$CPU_STATUS" = "200" ]; then
            echo "âœ… CPUå‘Šè­¦è§„åˆ™å¯è§¦å‘"
          elif [ "$CPU_STATUS" = "404" ]; then
            echo "âš ï¸ å‘Šè­¦æµ‹è¯•ç«¯ç‚¹ä¸å¯ç”¨ï¼ˆç”Ÿäº§ç¯å¢ƒæ­£å¸¸ï¼‰"
          else
            echo "::error::CPUå‘Šè­¦è§„åˆ™æµ‹è¯•å¤±è´¥: HTTP $CPU_STATUS"
          fi
          
          # æµ‹è¯•å†…å­˜å‘Šè­¦
          echo "æµ‹è¯•å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦..."
          MEMORY_ALERT=$(curl -s -w "HTTPSTATUS:%{http_code}" \
            -X POST "$API_URL/test/trigger-alert" \
            -H "Content-Type: application/json" \
            -d '{"metric": "memory_usage", "value": 90, "test": true}' \
            2>/dev/null || echo "HTTPSTATUS:404")
          
          MEMORY_STATUS=$(echo "$MEMORY_ALERT" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
          
          if [ "$MEMORY_STATUS" = "200" ]; then
            echo "âœ… å†…å­˜å‘Šè­¦è§„åˆ™å¯è§¦å‘"
          elif [ "$MEMORY_STATUS" = "404" ]; then
            echo "âš ï¸ å‘Šè­¦æµ‹è¯•ç«¯ç‚¹ä¸å¯ç”¨ï¼ˆç”Ÿäº§ç¯å¢ƒæ­£å¸¸ï¼‰"
          else
            echo "::error::å†…å­˜å‘Šè­¦è§„åˆ™æµ‹è¯•å¤±è´¥: HTTP $MEMORY_STATUS"
          fi

      - name: Test notification channels
        if: github.event.inputs.send_test_alerts == 'true'
        run: |
          echo "ğŸ“¢ æµ‹è¯•é€šçŸ¥æ¸ é“..."
          
          # å‘é€æµ‹è¯•Slacké€šçŸ¥
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "æµ‹è¯•Slacké€šçŸ¥..."
            
            SLACK_PAYLOAD='{
              "text": "ğŸ§ª ç›‘æ§ç³»ç»ŸéªŒè¯æµ‹è¯•é€šçŸ¥",
              "attachments": [
                {
                  "color": "good",
                  "fields": [
                    {
                      "title": "æµ‹è¯•æ—¶é—´",
                      "value": "'$(date)'",
                      "short": true
                    },
                    {
                      "title": "ç¯å¢ƒ",
                      "value": "${{ github.event.inputs.target_environment }}",
                      "short": true
                    },
                    {
                      "title": "è§¦å‘è€…",
                      "value": "${{ github.actor }}",
                      "short": true
                    }
                  ],
                  "footer": "GitHub Actions ç›‘æ§éªŒè¯"
                }
              ]
            }'
            
            SLACK_RESPONSE=$(curl -s -w "HTTPSTATUS:%{http_code}" \
              -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d "$SLACK_PAYLOAD" \
              2>/dev/null)
            
            SLACK_STATUS=$(echo "$SLACK_RESPONSE" | grep -o "HTTPSTATUS:[0-9]*" | cut -d: -f2)
            
            if [ "$SLACK_STATUS" = "200" ]; then
              echo "âœ… Slacké€šçŸ¥æ¸ é“æ­£å¸¸"
            else
              echo "::error::Slacké€šçŸ¥å¤±è´¥: HTTP $SLACK_STATUS"
            fi
          else
            echo "âš ï¸ Slack Webhookæœªé…ç½®"
          fi

  # æ€§èƒ½ç›‘æ§éªŒè¯
  performance-monitoring-verification:
    name: âš¡ Performance Monitoring Verification
    runs-on: ubuntu-latest
    needs: health-check-verification
    if: github.event.inputs.verification_type != 'health-only' && github.event.inputs.verification_type != 'alerts-only'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Playwright
        working-directory: zinses-rechner-frontend
        run: |
          npm ci
          npx playwright install chromium

      - name: Run performance monitoring tests
        working-directory: zinses-rechner-frontend
        env:
          PLAYWRIGHT_BASE_URL: ${{ needs.health-check-verification.outputs.frontend-url || 'https://zinses-rechner.de' }}
          VITE_API_BASE_URL: ${{ needs.health-check-verification.outputs.api-url || 'https://api.zinses-rechner.de' }}
        run: |
          echo "âš¡ è¿è¡Œæ€§èƒ½ç›‘æ§éªŒè¯æµ‹è¯•..."
          
          npx playwright test tests/monitoring/monitoring-verification.spec.ts \
            --project=chromium \
            --reporter=html \
            --output=../monitoring/reports/playwright

      - name: Upload monitoring test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: monitoring-verification-results
          path: |
            monitoring/reports/playwright/
            zinses-rechner-frontend/test-results/
          retention-days: 7

  # ç›‘æ§éªŒè¯æ‘˜è¦
  monitoring-verification-summary:
    name: ğŸ“Š Monitoring Verification Summary
    runs-on: ubuntu-latest
    needs: [health-check-verification, alert-rules-verification, performance-monitoring-verification]
    if: always()
    
    steps:
      - name: Generate monitoring verification summary
        run: |
          echo "# ğŸ” Zinses-Rechner ç›‘æ§ç³»ç»ŸéªŒè¯æŠ¥å‘Š" > monitoring-summary.md
          echo "" >> monitoring-summary.md
          echo "**éªŒè¯æ—¶é—´**: $(date)" >> monitoring-summary.md
          echo "**éªŒè¯ç±»å‹**: ${{ github.event.inputs.verification_type || 'scheduled' }}" >> monitoring-summary.md
          echo "**ç›®æ ‡ç¯å¢ƒ**: ${{ github.event.inputs.target_environment || 'production' }}" >> monitoring-summary.md
          echo "" >> monitoring-summary.md
          
          echo "## éªŒè¯ç»“æœæ‘˜è¦" >> monitoring-summary.md
          echo "- å¥åº·æ£€æŸ¥éªŒè¯: ${{ needs.health-check-verification.result }}" >> monitoring-summary.md
          echo "- å‘Šè­¦è§„åˆ™éªŒè¯: ${{ needs.alert-rules-verification.result }}" >> monitoring-summary.md
          echo "- æ€§èƒ½ç›‘æ§éªŒè¯: ${{ needs.performance-monitoring-verification.result }}" >> monitoring-summary.md
          echo "" >> monitoring-summary.md
          
          echo "## ç›‘æ§ç³»ç»ŸçŠ¶æ€" >> monitoring-summary.md
          
          # APIå¥åº·çŠ¶æ€
          API_HEALTH="${{ needs.health-check-verification.outputs.api-health }}"
          FRONTEND_HEALTH="${{ needs.health-check-verification.outputs.frontend-health }}"
          RESPONSE_TIME="${{ needs.health-check-verification.outputs.response-time }}"
          
          echo "### æœåŠ¡å¥åº·çŠ¶æ€" >> monitoring-summary.md
          echo "- **APIæœåŠ¡**: $([ "$API_HEALTH" = "healthy" ] && echo "âœ… æ­£å¸¸" || echo "âŒ å¼‚å¸¸")" >> monitoring-summary.md
          echo "- **å‰ç«¯æœåŠ¡**: $([ "$FRONTEND_HEALTH" = "healthy" ] && echo "âœ… æ­£å¸¸" || echo "âŒ å¼‚å¸¸")" >> monitoring-summary.md
          echo "- **APIå“åº”æ—¶é—´**: ${RESPONSE_TIME}ms" >> monitoring-summary.md
          echo "" >> monitoring-summary.md
          
          echo "### ç›‘æ§åŠŸèƒ½çŠ¶æ€" >> monitoring-summary.md
          if [ "${{ needs.health-check-verification.result }}" = "success" ] && 
             [ "${{ needs.alert-rules-verification.result }}" = "success" ] && 
             [ "${{ needs.performance-monitoring-verification.result }}" = "success" ]; then
            echo "ğŸŸ¢ **æ•´ä½“ç›‘æ§çŠ¶æ€: ä¼˜ç§€**" >> monitoring-summary.md
            echo "" >> monitoring-summary.md
            echo "æ‰€æœ‰ç›‘æ§åŠŸèƒ½æ­£å¸¸è¿è¡Œï¼Œå‘Šè­¦æœºåˆ¶å·¥ä½œæ­£å¸¸ã€‚" >> monitoring-summary.md
          elif [ "${{ needs.health-check-verification.result }}" = "success" ]; then
            echo "ğŸŸ¡ **æ•´ä½“ç›‘æ§çŠ¶æ€: è‰¯å¥½**" >> monitoring-summary.md
            echo "" >> monitoring-summary.md
            echo "åŸºç¡€ç›‘æ§åŠŸèƒ½æ­£å¸¸ï¼Œéƒ¨åˆ†é«˜çº§åŠŸèƒ½å¯èƒ½éœ€è¦å…³æ³¨ã€‚" >> monitoring-summary.md
          else
            echo "ğŸ”´ **æ•´ä½“ç›‘æ§çŠ¶æ€: éœ€è¦ä¿®å¤**" >> monitoring-summary.md
            echo "" >> monitoring-summary.md
            echo "å‘ç°ç›‘æ§ç³»ç»Ÿé—®é¢˜ï¼Œè¯·ç«‹å³æ£€æŸ¥å’Œä¿®å¤ã€‚" >> monitoring-summary.md
          fi
          
          echo "" >> monitoring-summary.md
          echo "## æ€§èƒ½æŒ‡æ ‡" >> monitoring-summary.md
          echo "- **APIå“åº”æ—¶é—´**: ${RESPONSE_TIME}ms $([ "$RESPONSE_TIME" -lt 1000 ] && echo "(âœ… æ­£å¸¸)" || echo "(âš ï¸ è¾ƒæ…¢)")" >> monitoring-summary.md
          echo "- **å¥åº·æ£€æŸ¥**: $([ "$API_HEALTH" = "healthy" ] && echo "âœ… é€šè¿‡" || echo "âŒ å¤±è´¥")" >> monitoring-summary.md
          echo "" >> monitoring-summary.md
          
          echo "## å»ºè®®è¡ŒåŠ¨" >> monitoring-summary.md
          if [ "${{ needs.health-check-verification.result }}" != "success" ]; then
            echo "1. ğŸ”´ ç«‹å³æ£€æŸ¥APIæœåŠ¡çŠ¶æ€" >> monitoring-summary.md
          fi
          if [ "${{ needs.alert-rules-verification.result }}" != "success" ]; then
            echo "2. ğŸŸ¡ éªŒè¯å‘Šè­¦è§„åˆ™é…ç½®" >> monitoring-summary.md
          fi
          if [ "${{ needs.performance-monitoring-verification.result }}" != "success" ]; then
            echo "3. ğŸŸ¡ æ£€æŸ¥æ€§èƒ½ç›‘æ§é…ç½®" >> monitoring-summary.md
          fi
          if [ "$RESPONSE_TIME" -gt 1000 ]; then
            echo "4. âš¡ ä¼˜åŒ–APIå“åº”æ€§èƒ½" >> monitoring-summary.md
          fi
          
          echo "" >> monitoring-summary.md
          echo "## è¯¦ç»†æŠ¥å‘Š" >> monitoring-summary.md
          echo "- ç›‘æ§éªŒè¯æµ‹è¯•: monitoring-verification-results" >> monitoring-summary.md
          echo "- æ‰§è¡Œæ—¥å¿—: è§GitHub Actionså·¥ä½œæµæ—¥å¿—" >> monitoring-summary.md

      - name: Upload monitoring summary
        uses: actions/upload-artifact@v4
        with:
          name: monitoring-verification-summary
          path: monitoring-summary.md

      - name: Comment PR with monitoring results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('monitoring-summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # ç›‘æ§æ•…éšœå‘Šè­¦
  monitoring-failure-alert:
    name: ğŸš¨ Monitoring Failure Alert
    runs-on: ubuntu-latest
    needs: [health-check-verification, alert-rules-verification, performance-monitoring-verification]
    if: failure()
    
    steps:
      - name: Send monitoring failure alert
        run: |
          echo "ğŸš¨ ç›‘æ§ç³»ç»ŸéªŒè¯å‘ç°é—®é¢˜ï¼"
          
          # å‘é€Slackå‘Šè­¦
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "ğŸš¨ Zinses-Rechner ç›‘æ§ç³»ç»ŸéªŒè¯å¤±è´¥",
                "attachments": [
                  {
                    "color": "danger",
                    "fields": [
                      {
                        "title": "éªŒè¯ç±»å‹",
                        "value": "${{ github.event.inputs.verification_type || 'scheduled' }}",
                        "short": true
                      },
                      {
                        "title": "ç¯å¢ƒ",
                        "value": "${{ github.event.inputs.target_environment || 'production' }}",
                        "short": true
                      },
                      {
                        "title": "åˆ†æ”¯",
                        "value": "${{ github.ref_name }}",
                        "short": true
                      },
                      {
                        "title": "å¤±è´¥ç»„ä»¶",
                        "value": "å¥åº·æ£€æŸ¥: ${{ needs.health-check-verification.result }}, å‘Šè­¦è§„åˆ™: ${{ needs.alert-rules-verification.result }}, æ€§èƒ½ç›‘æ§: ${{ needs.performance-monitoring-verification.result }}",
                        "short": false
                      }
                    ],
                    "footer": "ç›‘æ§éªŒè¯ç³»ç»Ÿ",
                    "ts": '${{ github.event.head_commit.timestamp }}'
                  }
                ]
              }' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          fi
