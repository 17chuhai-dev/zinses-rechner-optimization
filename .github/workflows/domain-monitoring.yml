name: Domain and SSL Monitoring

on:
  schedule:
    # æ¯å¤©æ—©ä¸Š8ç‚¹æ£€æŸ¥SSLè¯ä¹¦
    - cron: '0 8 * * *'
    # æ¯4å°æ—¶æ£€æŸ¥åŸŸåå¥åº·çŠ¶æ€
    - cron: '0 */4 * * *'
  
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type of check to perform'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - ssl-only
          - dns-only
          - performance-only

  push:
    branches:
      - main
    paths:
      - 'infrastructure/**'
      - '.github/workflows/domain-monitoring.yml'

env:
  DOMAINS: 'zinses-rechner.de,www.zinses-rechner.de,api.zinses-rechner.de,monitoring.zinses-rechner.de'

jobs:
  # DNSè§£ææ£€æŸ¥
  dns-check:
    name: ğŸŒ DNS Resolution Check
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type != 'ssl-only' && github.event.inputs.check_type != 'performance-only'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install DNS tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dnsutils

      - name: Check DNS resolution
        run: |
          echo "ğŸ” æ£€æŸ¥DNSè§£æçŠ¶æ€..."
          
          IFS=',' read -ra DOMAIN_ARRAY <<< "$DOMAINS"
          
          for domain in "${DOMAIN_ARRAY[@]}"; do
            echo "æ£€æŸ¥åŸŸå: $domain"
            
            # Aè®°å½•æ£€æŸ¥
            A_RECORD=$(dig +short "$domain" A)
            if [ -n "$A_RECORD" ]; then
              echo "âœ… $domain Aè®°å½•: $A_RECORD"
            else
              echo "âŒ $domain Aè®°å½•è§£æå¤±è´¥"
            fi
            
            # CNAMEè®°å½•æ£€æŸ¥
            CNAME_RECORD=$(dig +short "$domain" CNAME)
            if [ -n "$CNAME_RECORD" ]; then
              echo "âœ… $domain CNAMEè®°å½•: $CNAME_RECORD"
            fi
            
            echo ""
          done

      - name: Check nameservers
        run: |
          echo "ğŸ” æ£€æŸ¥Nameservers..."
          dig +short zinses-rechner.de NS

  # SSLè¯ä¹¦æ£€æŸ¥
  ssl-check:
    name: ğŸ”’ SSL Certificate Check
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type != 'dns-only' && github.event.inputs.check_type != 'performance-only'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check SSL certificates
        run: |
          echo "ğŸ”’ æ£€æŸ¥SSLè¯ä¹¦çŠ¶æ€..."
          
          IFS=',' read -ra DOMAIN_ARRAY <<< "$DOMAINS"
          
          for domain in "${DOMAIN_ARRAY[@]}"; do
            echo "æ£€æŸ¥SSLè¯ä¹¦: $domain"
            
            # è·å–è¯ä¹¦ä¿¡æ¯
            CERT_INFO=$(echo | timeout 10 openssl s_client -servername "$domain" -connect "$domain:443" 2>/dev/null | \
                       openssl x509 -noout -dates -subject -issuer 2>/dev/null)
            
            if [ $? -eq 0 ] && [ -n "$CERT_INFO" ]; then
              echo "âœ… $domain SSLè¯ä¹¦æœ‰æ•ˆ"
              
              # æ£€æŸ¥åˆ°æœŸæ—¶é—´
              EXPIRY_DATE=$(echo "$CERT_INFO" | grep "notAfter" | cut -d= -f2)
              if [ -n "$EXPIRY_DATE" ]; then
                EXPIRY_TIMESTAMP=$(date -d "$EXPIRY_DATE" +%s 2>/dev/null)
                CURRENT_TIMESTAMP=$(date +%s)
                DAYS_UNTIL_EXPIRY=$(( (EXPIRY_TIMESTAMP - CURRENT_TIMESTAMP) / 86400 ))
                
                if [ "$DAYS_UNTIL_EXPIRY" -gt 30 ]; then
                  echo "âœ… è¯ä¹¦æœ‰æ•ˆæœŸ: $DAYS_UNTIL_EXPIRY å¤©"
                elif [ "$DAYS_UNTIL_EXPIRY" -gt 7 ]; then
                  echo "âš ï¸ è¯ä¹¦å³å°†åˆ°æœŸ: $DAYS_UNTIL_EXPIRY å¤©"
                else
                  echo "ğŸš¨ è¯ä¹¦å³å°†åˆ°æœŸ: $DAYS_UNTIL_EXPIRY å¤©"
                  echo "::warning::SSL certificate for $domain expires in $DAYS_UNTIL_EXPIRY days"
                fi
              fi
              
              # æ˜¾ç¤ºè¯ä¹¦è¯¦æƒ…
              echo "$CERT_INFO" | sed 's/^/  /'
            else
              echo "âŒ $domain SSLè¯ä¹¦æ£€æŸ¥å¤±è´¥"
              echo "::error::SSL certificate check failed for $domain"
            fi
            
            echo ""
          done

      - name: SSL certificate expiry notification
        if: failure()
        run: |
          echo "ğŸš¨ SSLè¯ä¹¦æ£€æŸ¥å‘ç°é—®é¢˜ï¼"
          echo "è¯·æ£€æŸ¥ä¸Šè¿°è¾“å‡ºå¹¶åŠæ—¶æ›´æ–°è¯ä¹¦"

  # æ€§èƒ½å’Œå¯ç”¨æ€§æ£€æŸ¥
  performance-check:
    name: âš¡ Performance and Availability Check
    runs-on: ubuntu-latest
    if: github.event.inputs.check_type != 'dns-only' && github.event.inputs.check_type != 'ssl-only'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install performance tools
        run: |
          npm install -g lighthouse
          sudo apt-get install -y curl

      - name: Check domain accessibility
        run: |
          echo "ğŸŒ æ£€æŸ¥åŸŸåå¯è®¿é—®æ€§..."
          
          IFS=',' read -ra DOMAIN_ARRAY <<< "$DOMAINS"
          
          for domain in "${DOMAIN_ARRAY[@]}"; do
            echo "æµ‹è¯•åŸŸå: $domain"
            
            # HTTPçŠ¶æ€æ£€æŸ¥
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://$domain" || echo "000")
            RESPONSE_TIME=$(curl -o /dev/null -s -w '%{time_total}' --max-time 10 "https://$domain" 2>/dev/null || echo "timeout")
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… $domain è®¿é—®æ­£å¸¸ (çŠ¶æ€ç : $HTTP_STATUS)"
              
              if [ "$RESPONSE_TIME" != "timeout" ]; then
                RESPONSE_TIME_MS=$(echo "$RESPONSE_TIME * 1000" | bc 2>/dev/null || echo "0")
                echo "âš¡ å“åº”æ—¶é—´: ${RESPONSE_TIME_MS}ms"
                
                # æ€§èƒ½è¯„ä¼°
                if (( $(echo "$RESPONSE_TIME_MS < 1000" | bc -l 2>/dev/null || echo "0") )); then
                  echo "ğŸš€ æ€§èƒ½è¯„çº§: ä¼˜ç§€"
                elif (( $(echo "$RESPONSE_TIME_MS < 2000" | bc -l 2>/dev/null || echo "0") )); then
                  echo "ğŸ‘ æ€§èƒ½è¯„çº§: è‰¯å¥½"
                else
                  echo "âš ï¸ æ€§èƒ½è¯„çº§: éœ€è¦ä¼˜åŒ–"
                fi
              fi
            else
              echo "âŒ $domain è®¿é—®å¼‚å¸¸ (çŠ¶æ€ç : $HTTP_STATUS)"
              echo "::error::Domain $domain is not accessible (HTTP $HTTP_STATUS)"
            fi
            
            echo ""
          done

      - name: Test HTTPS redirect
        run: |
          echo "ğŸ”„ æµ‹è¯•HTTPSé‡å®šå‘..."
          
          # åªæµ‹è¯•ä¸»åŸŸåçš„HTTPé‡å®šå‘
          MAIN_DOMAINS=("zinses-rechner.de" "www.zinses-rechner.de")
          
          for domain in "${MAIN_DOMAINS[@]}"; do
            echo "æµ‹è¯•HTTPé‡å®šå‘: $domain"
            
            REDIRECT_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -L --max-time 10 "http://$domain" || echo "000")
            FINAL_URL=$(curl -s -o /dev/null -w "%{url_effective}" -L --max-time 10 "http://$domain" || echo "")
            
            if [[ "$FINAL_URL" == "https://"* ]]; then
              echo "âœ… $domain HTTPSé‡å®šå‘æ­£å¸¸"
            else
              echo "âŒ $domain HTTPSé‡å®šå‘å¼‚å¸¸"
              echo "::warning::HTTPS redirect may not be working for $domain"
            fi
          done

      - name: Run Lighthouse audit on main domain
        run: |
          echo "ğŸ” è¿è¡ŒLighthouseæ€§èƒ½å®¡è®¡..."
          
          lighthouse https://zinses-rechner.de \
            --output=json \
            --output=html \
            --output-path=./lighthouse-domain-audit \
            --chrome-flags="--headless --no-sandbox" \
            --preset=desktop \
            --quiet

      - name: Upload Lighthouse report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-domain-audit
          path: ./lighthouse-domain-audit.*

  # å®‰å…¨æ£€æŸ¥
  security-check:
    name: ğŸ›¡ï¸ Security Headers Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Check security headers
        run: |
          echo "ğŸ›¡ï¸ æ£€æŸ¥å®‰å…¨å¤´é…ç½®..."
          
          MAIN_DOMAIN="zinses-rechner.de"
          
          echo "æ£€æŸ¥åŸŸå: $MAIN_DOMAIN"
          HEADERS=$(curl -I -s --max-time 10 "https://$MAIN_DOMAIN" 2>/dev/null || echo "")
          
          # æ£€æŸ¥å…³é”®å®‰å…¨å¤´
          if echo "$HEADERS" | grep -qi "strict-transport-security"; then
            echo "âœ… HSTSå¤´å­˜åœ¨"
          else
            echo "âŒ HSTSå¤´ç¼ºå¤±"
            echo "::warning::HSTS header missing for $MAIN_DOMAIN"
          fi
          
          if echo "$HEADERS" | grep -qi "x-content-type-options"; then
            echo "âœ… X-Content-Type-Optionså¤´å­˜åœ¨"
          else
            echo "âŒ X-Content-Type-Optionså¤´ç¼ºå¤±"
          fi
          
          if echo "$HEADERS" | grep -qi "x-frame-options"; then
            echo "âœ… X-Frame-Optionså¤´å­˜åœ¨"
          else
            echo "âŒ X-Frame-Optionså¤´ç¼ºå¤±"
          fi
          
          if echo "$HEADERS" | grep -qi "content-security-policy"; then
            echo "âœ… CSPå¤´å­˜åœ¨"
          else
            echo "âŒ CSPå¤´ç¼ºå¤±"
          fi

  # ç»¼åˆæŠ¥å‘Š
  generate-report:
    name: ğŸ“Š Generate Monitoring Report
    runs-on: ubuntu-latest
    needs: [dns-check, ssl-check, performance-check, security-check]
    if: always()
    
    steps:
      - name: Generate comprehensive report
        run: |
          echo "ğŸ“Š ç”ŸæˆåŸŸåç›‘æ§ç»¼åˆæŠ¥å‘Š..."
          
          cat > domain-monitoring-report.md << EOF
          # Zinses-RechneråŸŸåç›‘æ§æŠ¥å‘Š
          
          **ç”Ÿæˆæ—¶é—´**: $(date)
          **æ£€æŸ¥ç±»å‹**: ${GITHUB_EVENT_NAME}
          
          ## æ£€æŸ¥ç»“æœæ‘˜è¦
          - DNSè§£ææ£€æŸ¥: ${{ needs.dns-check.result }}
          - SSLè¯ä¹¦æ£€æŸ¥: ${{ needs.ssl-check.result }}
          - æ€§èƒ½æ£€æŸ¥: ${{ needs.performance-check.result }}
          - å®‰å…¨æ£€æŸ¥: ${{ needs.security-check.result }}
          
          ## åŸŸååˆ—è¡¨
          $(echo "$DOMAINS" | tr ',' '\n' | sed 's/^/- /')
          
          ## å»ºè®®æ“ä½œ
          $(if [ "${{ needs.ssl-check.result }}" != "success" ]; then echo "- æ£€æŸ¥SSLè¯ä¹¦çŠ¶æ€"; fi)
          $(if [ "${{ needs.performance-check.result }}" != "success" ]; then echo "- ä¼˜åŒ–åŸŸåæ€§èƒ½"; fi)
          $(if [ "${{ needs.security-check.result }}" != "success" ]; then echo "- é…ç½®å®‰å…¨å¤´"; fi)
          
          ## ä¸‹æ¬¡æ£€æŸ¥
          - å®šæœŸæ£€æŸ¥: æ¯4å°æ—¶
          - SSLæ£€æŸ¥: æ¯å¤©æ—©ä¸Š8ç‚¹
          EOF
          
          echo "ğŸ“„ æŠ¥å‘Šå·²ç”Ÿæˆ"

      - name: Upload monitoring report
        uses: actions/upload-artifact@v4
        with:
          name: domain-monitoring-report
          path: domain-monitoring-report.md

  # å¤±è´¥é€šçŸ¥
  notify-issues:
    name: ğŸ“¢ Notify Domain Issues
    runs-on: ubuntu-latest
    needs: [dns-check, ssl-check, performance-check, security-check]
    if: failure()
    
    steps:
      - name: Send failure notification
        run: |
          echo "ğŸš¨ åŸŸåç›‘æ§å‘ç°é—®é¢˜ï¼"
          echo "è¯·æ£€æŸ¥ä»¥ä¸‹æ–¹é¢ï¼š"
          echo "- DNSè§£æçŠ¶æ€"
          echo "- SSLè¯ä¹¦æœ‰æ•ˆæ€§"
          echo "- åŸŸåå¯è®¿é—®æ€§"
          echo "- å®‰å…¨é…ç½®"
          
          # è¿™é‡Œåº”è¯¥å‘é€å®é™…çš„é€šçŸ¥ï¼ˆSlackã€é‚®ä»¶ç­‰ï¼‰
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"ğŸš¨ Zinses-RechneråŸŸåç›‘æ§å‘ç°é—®é¢˜ï¼Œè¯·ç«‹å³æ£€æŸ¥ï¼"}' \
              "${{ secrets.SLACK_WEBHOOK_URL }}" || true
          fi
