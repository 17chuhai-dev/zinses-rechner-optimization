name: Performance and Load Tests

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨3ç‚¹è¿è¡Œæ€§èƒ½æµ‹è¯•
    - cron: '0 3 * * *'
  
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of performance test'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - load-only
          - lighthouse-only
          - stress-only
      
      target_environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

  push:
    branches: [ main ]
    paths:
      - 'tests/performance/**'
      - '.github/workflows/performance-tests.yml'

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ç¯å¢ƒå‡†å¤‡
  setup:
    name: ğŸ—ï¸ Setup Performance Test Environment
    runs-on: ubuntu-latest
    
    outputs:
      api-url: ${{ steps.set-urls.outputs.api-url }}
      frontend-url: ${{ steps.set-urls.outputs.frontend-url }}
      test-duration: ${{ steps.set-config.outputs.duration }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set target URLs
        id: set-urls
        run: |
          if [ "${{ github.event.inputs.target_environment }}" = "production" ]; then
            echo "api-url=https://api.zinses-rechner.de" >> $GITHUB_OUTPUT
            echo "frontend-url=https://zinses-rechner.de" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.target_environment }}" = "staging" ]; then
            echo "api-url=https://staging-api.zinses-rechner.de" >> $GITHUB_OUTPUT
            echo "frontend-url=https://staging.zinses-rechner.de" >> $GITHUB_OUTPUT
          else
            echo "api-url=http://localhost:8000" >> $GITHUB_OUTPUT
            echo "frontend-url=http://localhost:5173" >> $GITHUB_OUTPUT
          fi

      - name: Set test configuration
        id: set-config
        run: |
          if [ "${{ github.event.inputs.test_type }}" = "stress-only" ]; then
            echo "duration=1800" >> $GITHUB_OUTPUT  # 30åˆ†é’Ÿå‹åŠ›æµ‹è¯•
          else
            echo "duration=900" >> $GITHUB_OUTPUT   # 15åˆ†é’Ÿæ ‡å‡†æµ‹è¯•
          fi

      - name: Verify target availability
        run: |
          echo "éªŒè¯ç›®æ ‡ç¯å¢ƒå¯ç”¨æ€§..."
          
          API_URL="${{ steps.set-urls.outputs.api-url }}"
          FRONTEND_URL="${{ steps.set-urls.outputs.frontend-url }}"
          
          # æ£€æŸ¥APIå¥åº·çŠ¶æ€
          if curl -f -s "$API_URL/health" > /dev/null; then
            echo "âœ… APIæœåŠ¡å¯ç”¨: $API_URL"
          else
            echo "âŒ APIæœåŠ¡ä¸å¯ç”¨: $API_URL"
            exit 1
          fi
          
          # æ£€æŸ¥å‰ç«¯å¯ç”¨æ€§
          if curl -f -s "$FRONTEND_URL" > /dev/null; then
            echo "âœ… å‰ç«¯æœåŠ¡å¯ç”¨: $FRONTEND_URL"
          else
            echo "âŒ å‰ç«¯æœåŠ¡ä¸å¯ç”¨: $FRONTEND_URL"
            exit 1
          fi

  # APIè´Ÿè½½æµ‹è¯•
  api-load-tests:
    name: ğŸš€ API Load Tests
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.inputs.test_type != 'lighthouse-only'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Artillery
        run: npm install -g artillery

      - name: Create reports directory
        run: mkdir -p reports/performance/artillery

      - name: Run API load tests
        env:
          API_BASE_URL: ${{ needs.setup.outputs.api-url }}
          TEST_DURATION: ${{ needs.setup.outputs.test-duration }}
        run: |
          echo "ğŸš€ è¿è¡ŒAPIè´Ÿè½½æµ‹è¯•..."
          echo "ç›®æ ‡API: $API_BASE_URL"
          echo "æµ‹è¯•æ—¶é•¿: $TEST_DURATION ç§’"
          
          # è¿è¡ŒArtilleryè´Ÿè½½æµ‹è¯•
          artillery run tests/performance/artillery-load-test.yml \
            --output reports/performance/artillery/load-test-results.json \
            --config target="$API_BASE_URL"

      - name: Generate Artillery HTML report
        run: |
          artillery report reports/performance/artillery/load-test-results.json \
            --output reports/performance/artillery/load-test-report.html

      - name: Analyze load test results
        run: |
          echo "ğŸ“Š åˆ†æè´Ÿè½½æµ‹è¯•ç»“æœ..."
          
          if [ -f "reports/performance/artillery/load-test-results.json" ]; then
            # æå–å…³é”®æŒ‡æ ‡
            if command -v jq &> /dev/null; then
              RESPONSE_TIME_P95=$(jq -r '.aggregate.latency.p95' reports/performance/artillery/load-test-results.json)
              RPS=$(jq -r '.aggregate.rates.http_request_rate' reports/performance/artillery/load-test-results.json)
              ERROR_RATE=$(jq -r '.aggregate.counters.errors // 0' reports/performance/artillery/load-test-results.json)
              
              echo "P95å“åº”æ—¶é—´: ${RESPONSE_TIME_P95}ms"
              echo "è¯·æ±‚é€Ÿç‡: ${RPS} RPS"
              echo "é”™è¯¯æ•°é‡: ${ERROR_RATE}"
              
              # è®¾ç½®GitHubè¾“å‡º
              echo "response-time-p95=$RESPONSE_TIME_P95" >> $GITHUB_OUTPUT
              echo "rps=$RPS" >> $GITHUB_OUTPUT
              echo "error-rate=$ERROR_RATE" >> $GITHUB_OUTPUT
              
              # æ£€æŸ¥æ€§èƒ½ç›®æ ‡
              if (( $(echo "$RESPONSE_TIME_P95 > 500" | bc -l) )); then
                echo "::warning::APIå“åº”æ—¶é—´è¶…æ ‡: ${RESPONSE_TIME_P95}ms > 500ms"
              fi
              
              if (( $(echo "$RPS < 1000" | bc -l) )); then
                echo "::warning::å¹¶å‘å¤„ç†èƒ½åŠ›ä¸è¶³: ${RPS} RPS < 1000 RPS"
              fi
            fi
          fi

      - name: Upload Artillery reports
        uses: actions/upload-artifact@v4
        with:
          name: artillery-load-test-reports
          path: reports/performance/artillery/
          retention-days: 30

  # å‰ç«¯æ€§èƒ½æµ‹è¯•
  frontend-performance-tests:
    name: âš¡ Frontend Performance Tests
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.inputs.test_type != 'load-only' && github.event.inputs.test_type != 'stress-only'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli lighthouse

      - name: Create reports directory
        run: mkdir -p reports/performance/lighthouse

      - name: Run Lighthouse performance audit
        env:
          FRONTEND_URL: ${{ needs.setup.outputs.frontend-url }}
        run: |
          echo "âš¡ è¿è¡Œå‰ç«¯æ€§èƒ½æµ‹è¯•..."
          echo "ç›®æ ‡URL: $FRONTEND_URL"
          
          # æ¡Œé¢ç«¯æ€§èƒ½æµ‹è¯•
          lighthouse "$FRONTEND_URL" \
            --output=json \
            --output=html \
            --output-path=reports/performance/lighthouse/desktop-performance \
            --preset=desktop \
            --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage" \
            --throttling-method=devtools
          
          # ç§»åŠ¨ç«¯æ€§èƒ½æµ‹è¯•
          lighthouse "$FRONTEND_URL" \
            --output=json \
            --output=html \
            --output-path=reports/performance/lighthouse/mobile-performance \
            --preset=mobile \
            --chrome-flags="--headless --no-sandbox --disable-dev-shm-usage" \
            --throttling-method=devtools

      - name: Analyze Lighthouse results
        run: |
          echo "ğŸ“Š åˆ†æLighthouseæ€§èƒ½ç»“æœ..."
          
          # åˆ†ææ¡Œé¢ç«¯ç»“æœ
          if [ -f "reports/performance/lighthouse/desktop-performance.json" ]; then
            DESKTOP_SCORE=$(jq -r '.categories.performance.score * 100' reports/performance/lighthouse/desktop-performance.json)
            DESKTOP_LCP=$(jq -r '.audits["largest-contentful-paint"].numericValue' reports/performance/lighthouse/desktop-performance.json)
            DESKTOP_FID=$(jq -r '.audits["max-potential-fid"].numericValue' reports/performance/lighthouse/desktop-performance.json)
            DESKTOP_CLS=$(jq -r '.audits["cumulative-layout-shift"].numericValue' reports/performance/lighthouse/desktop-performance.json)
            
            echo "æ¡Œé¢ç«¯æ€§èƒ½è¯„åˆ†: ${DESKTOP_SCORE}/100"
            echo "æ¡Œé¢ç«¯LCP: ${DESKTOP_LCP}ms"
            echo "æ¡Œé¢ç«¯FID: ${DESKTOP_FID}ms"
            echo "æ¡Œé¢ç«¯CLS: ${DESKTOP_CLS}"
            
            # æ£€æŸ¥Core Web Vitals
            if (( $(echo "$DESKTOP_LCP > 2500" | bc -l) )); then
              echo "::warning::æ¡Œé¢ç«¯LCPè¶…æ ‡: ${DESKTOP_LCP}ms > 2500ms"
            fi
          fi
          
          # åˆ†æç§»åŠ¨ç«¯ç»“æœ
          if [ -f "reports/performance/lighthouse/mobile-performance.json" ]; then
            MOBILE_SCORE=$(jq -r '.categories.performance.score * 100' reports/performance/lighthouse/mobile-performance.json)
            MOBILE_LCP=$(jq -r '.audits["largest-contentful-paint"].numericValue' reports/performance/lighthouse/mobile-performance.json)
            
            echo "ç§»åŠ¨ç«¯æ€§èƒ½è¯„åˆ†: ${MOBILE_SCORE}/100"
            echo "ç§»åŠ¨ç«¯LCP: ${MOBILE_LCP}ms"
            
            if (( $(echo "$MOBILE_SCORE < 85" | bc -l) )); then
              echo "::warning::ç§»åŠ¨ç«¯æ€§èƒ½è¯„åˆ†ä½äº85åˆ†: ${MOBILE_SCORE}"
            fi
          fi

      - name: Upload Lighthouse reports
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-performance-reports
          path: reports/performance/lighthouse/
          retention-days: 30

  # å‹åŠ›æµ‹è¯•
  stress-tests:
    name: ğŸ’ª Stress Tests
    runs-on: ubuntu-latest
    needs: setup
    if: github.event.inputs.test_type == 'full' || github.event.inputs.test_type == 'stress-only'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install Artillery
        run: npm install -g artillery

      - name: Run stress tests
        env:
          API_BASE_URL: ${{ needs.setup.outputs.api-url }}
        run: |
          echo "ğŸ’ª è¿è¡Œå‹åŠ›æµ‹è¯•..."
          
          # åˆ›å»ºå‹åŠ›æµ‹è¯•é…ç½®
          cat > stress-test-config.yml << EOF
          config:
            target: '$API_BASE_URL'
            phases:
              - duration: 60
                arrivalRate: 500
              - duration: 120
                arrivalRate: 1000
              - duration: 180
                arrivalRate: 1500
              - duration: 120
                arrivalRate: 2000
              - duration: 60
                arrivalRate: 2500
          
          scenarios:
            - name: "å‹åŠ›æµ‹è¯•"
              flow:
                - post:
                    url: "/api/v1/calculate/compound-interest"
                    json:
                      principal: 10000
                      annual_rate: 4.0
                      years: 10
                      monthly_payment: 500
                      compound_frequency: "monthly"
          EOF
          
          # æ‰§è¡Œå‹åŠ›æµ‹è¯•
          artillery run stress-test-config.yml \
            --output reports/stress-test-results.json

      - name: Analyze stress test results
        run: |
          if [ -f "reports/stress-test-results.json" ]; then
            MAX_RPS=$(jq -r '.aggregate.rates.http_request_rate' reports/stress-test-results.json)
            ERROR_COUNT=$(jq -r '.aggregate.counters.errors // 0' reports/stress-test-results.json)
            
            echo "æœ€å¤§RPS: $MAX_RPS"
            echo "é”™è¯¯æ€»æ•°: $ERROR_COUNT"
            
            if (( $(echo "$MAX_RPS < 1000" | bc -l) )); then
              echo "::error::ç³»ç»Ÿæœªè¾¾åˆ°æœ€ä½RPSè¦æ±‚: $MAX_RPS < 1000"
              exit 1
            fi
          fi

  # æ€§èƒ½æŠ¥å‘Šæ±‡æ€»
  performance-summary:
    name: ğŸ“Š Performance Summary
    runs-on: ubuntu-latest
    needs: [setup, api-load-tests, frontend-performance-tests, stress-tests]
    if: always()
    
    steps:
      - name: Download all performance artifacts
        uses: actions/download-artifact@v4
        with:
          path: performance-artifacts

      - name: Generate performance summary
        run: |
          echo "# ğŸš€ Zinses-Rechner æ€§èƒ½æµ‹è¯•æŠ¥å‘Š" > performance-summary.md
          echo "" >> performance-summary.md
          echo "**æ‰§è¡Œæ—¶é—´**: $(date)" >> performance-summary.md
          echo "**ç›®æ ‡ç¯å¢ƒ**: ${{ github.event.inputs.target_environment || 'production' }}" >> performance-summary.md
          echo "**æµ‹è¯•ç±»å‹**: ${{ github.event.inputs.test_type || 'full' }}" >> performance-summary.md
          echo "" >> performance-summary.md
          
          echo "## æµ‹è¯•ç»“æœæ‘˜è¦" >> performance-summary.md
          echo "- APIè´Ÿè½½æµ‹è¯•: ${{ needs.api-load-tests.result }}" >> performance-summary.md
          echo "- å‰ç«¯æ€§èƒ½æµ‹è¯•: ${{ needs.frontend-performance-tests.result }}" >> performance-summary.md
          echo "- å‹åŠ›æµ‹è¯•: ${{ needs.stress-tests.result }}" >> performance-summary.md
          echo "" >> performance-summary.md
          
          echo "## æ€§èƒ½æŒ‡æ ‡" >> performance-summary.md
          echo "### ç›®æ ‡ vs å®é™…" >> performance-summary.md
          echo "| æŒ‡æ ‡ | ç›®æ ‡ | çŠ¶æ€ |" >> performance-summary.md
          echo "|------|------|------|" >> performance-summary.md
          echo "| APIå“åº”æ—¶é—´ | < 500ms | ${{ needs.api-load-tests.result == 'success' && 'âœ… è¾¾æ ‡' || 'âŒ è¶…æ ‡' }} |" >> performance-summary.md
          echo "| å¹¶å‘å¤„ç†èƒ½åŠ› | > 1000 RPS | ${{ needs.api-load-tests.result == 'success' && 'âœ… è¾¾æ ‡' || 'âŒ ä¸è¶³' }} |" >> performance-summary.md
          echo "| å‰ç«¯æ€§èƒ½è¯„åˆ† | > 85åˆ† | ${{ needs.frontend-performance-tests.result == 'success' && 'âœ… è¾¾æ ‡' || 'âŒ ä¸è¶³' }} |" >> performance-summary.md
          echo "| ç³»ç»Ÿç¨³å®šæ€§ | æ— å´©æºƒ | ${{ needs.stress-tests.result == 'success' && 'âœ… ç¨³å®š' || 'âŒ ä¸ç¨³å®š' }} |" >> performance-summary.md
          echo "" >> performance-summary.md
          
          if [ "${{ needs.api-load-tests.result }}" != "success" ] || 
             [ "${{ needs.frontend-performance-tests.result }}" != "success" ] || 
             [ "${{ needs.stress-tests.result }}" != "success" ]; then
            echo "## âš ï¸ æ€§èƒ½é—®é¢˜" >> performance-summary.md
            echo "å‘ç°æ€§èƒ½é—®é¢˜ï¼Œå»ºè®®ç«‹å³ä¼˜åŒ–ï¼š" >> performance-summary.md
            echo "1. æ£€æŸ¥APIå“åº”æ—¶é—´ç“¶é¢ˆ" >> performance-summary.md
            echo "2. ä¼˜åŒ–å‰ç«¯èµ„æºåŠ è½½" >> performance-summary.md
            echo "3. è°ƒæ•´ç¼“å­˜ç­–ç•¥" >> performance-summary.md
            echo "4. ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨" >> performance-summary.md
            echo "" >> performance-summary.md
          fi
          
          echo "## ğŸ“ è¯¦ç»†æŠ¥å‘Š" >> performance-summary.md
          echo "- Artilleryè´Ÿè½½æµ‹è¯•: artillery-load-test-reports" >> performance-summary.md
          echo "- Lighthouseæ€§èƒ½æŠ¥å‘Š: lighthouse-performance-reports" >> performance-summary.md
          echo "- æ€§èƒ½ä»ªè¡¨ç›˜: tests/performance/performance-dashboard.html" >> performance-summary.md

      - name: Upload performance summary
        uses: actions/upload-artifact@v4
        with:
          name: performance-summary
          path: performance-summary.md

      - name: Comment PR with performance results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('performance-summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # æ€§èƒ½å‘Šè­¦
  performance-alerts:
    name: ğŸš¨ Performance Alerts
    runs-on: ubuntu-latest
    needs: [api-load-tests, frontend-performance-tests, stress-tests]
    if: failure()
    
    steps:
      - name: Send performance alert
        run: |
          echo "ğŸš¨ æ€§èƒ½æµ‹è¯•å‘ç°é—®é¢˜ï¼"
          
          # å‘é€Slacké€šçŸ¥
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "ğŸš¨ Zinses-Rechner æ€§èƒ½æµ‹è¯•å‘Šè­¦",
                "attachments": [
                  {
                    "color": "danger",
                    "fields": [
                      {
                        "title": "ç¯å¢ƒ",
                        "value": "${{ github.event.inputs.target_environment || 'production' }}",
                        "short": true
                      },
                      {
                        "title": "æµ‹è¯•ç±»å‹",
                        "value": "${{ github.event.inputs.test_type || 'full' }}",
                        "short": true
                      },
                      {
                        "title": "åˆ†æ”¯",
                        "value": "${{ github.ref_name }}",
                        "short": true
                      }
                    ],
                    "footer": "æ€§èƒ½ç›‘æ§ç³»ç»Ÿ",
                    "ts": '${{ github.event.head_commit.timestamp }}'
                  }
                ]
              }' \
              ${{ secrets.SLACK_WEBHOOK_URL }}
          fi
