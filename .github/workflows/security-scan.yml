name: Security Vulnerability Scan

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨1ç‚¹è¿è¡Œå®‰å…¨æ‰«æ
    - cron: '0 1 * * *'
    # æ¯å‘¨æ—¥è¿›è¡Œå…¨é¢å®‰å…¨å®¡è®¡
    - cron: '0 2 * * 0'
  
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - baseline
          - dependencies-only
          - web-app-only
          - api-only
      
      target_environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
          - development

  push:
    branches: [ main ]
    paths:
      - 'security/**'
      - '.github/workflows/security-scan.yml'
      - '**/package*.json'
      - '**/requirements*.txt'

  pull_request:
    branches: [ main ]
    paths:
      - 'security/**'
      - '**/package*.json'
      - '**/requirements*.txt'

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ä¾èµ–æ¼æ´æ‰«æ
  dependency-scan:
    name: ğŸ“¦ Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type != 'web-app-only' && github.event.inputs.scan_type != 'api-only'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            zinses-rechner-frontend/package-lock.json
            cloudflare-workers/api-worker/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Create security reports directory
        run: mkdir -p security/reports/{npm-audit,snyk,safety}

      - name: Run npm audit - Frontend
        working-directory: zinses-rechner-frontend
        run: |
          echo "ğŸ“¦ æ‰«æå‰ç«¯ä¾èµ–æ¼æ´..."
          
          # ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
          npm audit --json > ../security/reports/npm-audit/frontend-audit.json 2>/dev/null || true
          npm audit > ../security/reports/npm-audit/frontend-audit.txt 2>/dev/null || true
          
          # æ£€æŸ¥é«˜å±æ¼æ´
          HIGH_VULNS=$(npm audit --audit-level=high --json 2>/dev/null | jq -r '.metadata.vulnerabilities.high // 0' || echo "0")
          CRITICAL_VULNS=$(npm audit --audit-level=critical --json 2>/dev/null | jq -r '.metadata.vulnerabilities.critical // 0' || echo "0")
          
          echo "å‰ç«¯é«˜å±æ¼æ´: $HIGH_VULNS"
          echo "å‰ç«¯ä¸¥é‡æ¼æ´: $CRITICAL_VULNS"
          
          if [ "$CRITICAL_VULNS" -gt 0 ]; then
            echo "::error::å‘ç°å‰ç«¯ä¸¥é‡å®‰å…¨æ¼æ´: $CRITICAL_VULNS ä¸ª"
            exit 1
          elif [ "$HIGH_VULNS" -gt 0 ]; then
            echo "::warning::å‘ç°å‰ç«¯é«˜å±å®‰å…¨æ¼æ´: $HIGH_VULNS ä¸ª"
          fi

      - name: Run npm audit - API Worker
        working-directory: cloudflare-workers/api-worker
        run: |
          echo "ğŸ“¦ æ‰«æAPI Workerä¾èµ–æ¼æ´..."
          
          npm audit --json > ../../security/reports/npm-audit/api-worker-audit.json 2>/dev/null || true
          npm audit > ../../security/reports/npm-audit/api-worker-audit.txt 2>/dev/null || true
          
          HIGH_VULNS=$(npm audit --audit-level=high --json 2>/dev/null | jq -r '.metadata.vulnerabilities.high // 0' || echo "0")
          
          if [ "$HIGH_VULNS" -gt 0 ]; then
            echo "::warning::å‘ç°API Workeré«˜å±æ¼æ´: $HIGH_VULNS ä¸ª"
          fi

      - name: Install and run Snyk
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ -n "$SNYK_TOKEN" ]; then
            echo "ğŸ” è¿è¡ŒSnykå®‰å…¨æ‰«æ..."
            
            npm install -g snyk
            snyk auth $SNYK_TOKEN
            
            # æ‰«æå‰ç«¯
            cd zinses-rechner-frontend
            snyk test --json > ../security/reports/snyk/frontend-snyk.json 2>/dev/null || true
            snyk test --severity-threshold=high || echo "::warning::Snykå‘ç°å‰ç«¯é«˜å±æ¼æ´"
            cd ..
            
            # æ‰«æAPI Worker
            cd cloudflare-workers/api-worker
            snyk test --json > ../../security/reports/snyk/api-worker-snyk.json 2>/dev/null || true
            snyk test --severity-threshold=high || echo "::warning::Snykå‘ç°API Workeré«˜å±æ¼æ´"
            cd ../..
            
          else
            echo "âš ï¸ SNYK_TOKENæœªé…ç½®ï¼Œè·³è¿‡Snykæ‰«æ"
          fi

      - name: Install and run Safety (Python)
        working-directory: backend
        run: |
          echo "ğŸ æ‰«æPythonä¾èµ–æ¼æ´..."
          
          pip install safety
          safety check --json > ../security/reports/safety/python-safety.json 2>/dev/null || true
          safety check || echo "::warning::Safetyå‘ç°Pythonä¾èµ–æ¼æ´"

      - name: Upload dependency scan reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-scan-reports
          path: security/reports/
          retention-days: 30

  # Webåº”ç”¨å®‰å…¨æ‰«æ
  web-app-scan:
    name: ğŸ•·ï¸ Web Application Security Scan
    runs-on: ubuntu-latest
    if: github.event.inputs.scan_type != 'dependencies-only'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set target URLs
        id: set-urls
        run: |
          if [ "${{ github.event.inputs.target_environment }}" = "production" ]; then
            echo "frontend-url=https://zinses-rechner.de" >> $GITHUB_OUTPUT
            echo "api-url=https://api.zinses-rechner.de" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.target_environment }}" = "staging" ]; then
            echo "frontend-url=https://staging.zinses-rechner.de" >> $GITHUB_OUTPUT
            echo "api-url=https://staging-api.zinses-rechner.de" >> $GITHUB_OUTPUT
          else
            echo "frontend-url=http://localhost:5173" >> $GITHUB_OUTPUT
            echo "api-url=http://localhost:8000" >> $GITHUB_OUTPUT
          fi

      - name: Create ZAP reports directory
        run: mkdir -p security/reports/zap

      - name: Run OWASP ZAP Baseline Scan - Frontend
        if: github.event.inputs.scan_type != 'api-only'
        run: |
          echo "ğŸ•·ï¸ è¿è¡Œå‰ç«¯åŸºçº¿å®‰å…¨æ‰«æ..."
          
          docker run -t --rm \
            -v "$(pwd)/security/reports/zap:/zap/wrk/:rw" \
            owasp/zap2docker-stable \
            zap-baseline.py \
            -t "${{ steps.set-urls.outputs.frontend-url }}" \
            -g gen.conf \
            -r "frontend-baseline-$(date +%Y%m%d_%H%M%S).html" \
            -J "frontend-baseline-$(date +%Y%m%d_%H%M%S).json" \
            -x "frontend-baseline-$(date +%Y%m%d_%H%M%S).xml" \
            || echo "::warning::ZAPå‰ç«¯æ‰«æå‘ç°å®‰å…¨é—®é¢˜"

      - name: Run OWASP ZAP API Scan
        if: github.event.inputs.scan_type != 'frontend-only'
        run: |
          echo "ğŸ”— è¿è¡ŒAPIå®‰å…¨æ‰«æ..."
          
          # åˆ›å»ºAPIæ‰«æé…ç½®
          cat > /tmp/api-scan-config.yaml << EOF
          openapi: "3.0.0"
          info:
            title: "Zinses-Rechner API"
            version: "1.0.0"
          servers:
            - url: "${{ steps.set-urls.outputs.api-url }}"
          paths:
            /health:
              get:
                summary: "Health check"
            /api/v1/calculate/compound-interest:
              post:
                summary: "Calculate compound interest"
                requestBody:
                  content:
                    application/json:
                      schema:
                        type: object
                        properties:
                          principal: { type: number }
                          annual_rate: { type: number }
                          years: { type: integer }
                          monthly_payment: { type: number }
          EOF
          
          docker run -t --rm \
            -v "$(pwd)/security/reports/zap:/zap/wrk/:rw" \
            -v "/tmp/api-scan-config.yaml:/zap/wrk/api-config.yaml:ro" \
            owasp/zap2docker-stable \
            zap-api-scan.py \
            -t "/zap/wrk/api-config.yaml" \
            -f openapi \
            -r "api-scan-$(date +%Y%m%d_%H%M%S).html" \
            -J "api-scan-$(date +%Y%m%d_%H%M%S).json" \
            -x "api-scan-$(date +%Y%m%d_%H%M%S).xml" \
            || echo "::warning::ZAP APIæ‰«æå‘ç°å®‰å…¨é—®é¢˜"

      - name: Run Full ZAP Scan (Weekly)
        if: github.event.schedule == '0 2 * * 0' || github.event.inputs.scan_type == 'full'
        run: |
          echo "ğŸ” è¿è¡Œå…¨é¢å®‰å…¨æ‰«æ..."
          
          docker run -t --rm \
            -v "$(pwd)/security/reports/zap:/zap/wrk/:rw" \
            owasp/zap2docker-stable \
            zap-full-scan.py \
            -t "${{ steps.set-urls.outputs.frontend-url }}" \
            -g gen.conf \
            -r "full-scan-$(date +%Y%m%d_%H%M%S).html" \
            -J "full-scan-$(date +%Y%m%d_%H%M%S).json" \
            -x "full-scan-$(date +%Y%m%d_%H%M%S).xml" \
            || echo "::warning::ZAPå…¨é¢æ‰«æå‘ç°å®‰å…¨é—®é¢˜"

      - name: Upload ZAP scan reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-scan-reports
          path: security/reports/zap/
          retention-days: 30

  # å®‰å…¨é…ç½®éªŒè¯
  security-config-check:
    name: âš™ï¸ Security Configuration Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check security headers configuration
        run: |
          echo "ğŸ›¡ï¸ éªŒè¯å®‰å…¨å¤´é…ç½®..."
          
          TARGET_URL="${{ needs.web-app-scan.outputs.frontend-url || 'https://zinses-rechner.de' }}"
          
          # æ£€æŸ¥å…³é”®å®‰å…¨å¤´
          HEADERS=$(curl -I -s --max-time 10 "$TARGET_URL" 2>/dev/null || echo "")
          
          # HSTSæ£€æŸ¥
          if echo "$HEADERS" | grep -qi "strict-transport-security"; then
            echo "âœ… HSTSå¤´é…ç½®æ­£ç¡®"
          else
            echo "::error::HSTSå¤´ç¼ºå¤±æˆ–é…ç½®é”™è¯¯"
          fi
          
          # CSPæ£€æŸ¥
          if echo "$HEADERS" | grep -qi "content-security-policy"; then
            echo "âœ… CSPå¤´é…ç½®æ­£ç¡®"
          else
            echo "::warning::CSPå¤´ç¼ºå¤±"
          fi
          
          # X-Frame-Optionsæ£€æŸ¥
          if echo "$HEADERS" | grep -qi "x-frame-options"; then
            echo "âœ… X-Frame-Optionså¤´é…ç½®æ­£ç¡®"
          else
            echo "::warning::X-Frame-Optionså¤´ç¼ºå¤±"
          fi
          
          # X-Content-Type-Optionsæ£€æŸ¥
          if echo "$HEADERS" | grep -qi "x-content-type-options"; then
            echo "âœ… X-Content-Type-Optionså¤´é…ç½®æ­£ç¡®"
          else
            echo "::warning::X-Content-Type-Optionså¤´ç¼ºå¤±"
          fi

      - name: Check SSL/TLS configuration
        run: |
          echo "ğŸ”’ éªŒè¯SSL/TLSé…ç½®..."
          
          TARGET_DOMAIN="zinses-rechner.de"
          
          # æ£€æŸ¥SSLè¯ä¹¦
          echo | openssl s_client -servername "$TARGET_DOMAIN" -connect "$TARGET_DOMAIN:443" 2>/dev/null | \
          openssl x509 -noout -dates -subject -issuer || echo "::error::SSLè¯ä¹¦æ£€æŸ¥å¤±è´¥"
          
          # æ£€æŸ¥TLSç‰ˆæœ¬æ”¯æŒ
          if echo | openssl s_client -tls1_2 -servername "$TARGET_DOMAIN" -connect "$TARGET_DOMAIN:443" 2>/dev/null | grep -q "Verify return code: 0"; then
            echo "âœ… TLS 1.2æ”¯æŒæ­£å¸¸"
          else
            echo "::error::TLS 1.2æ”¯æŒå¼‚å¸¸"
          fi

  # å®‰å…¨æ‰«æç»“æœæ±‡æ€»
  security-summary:
    name: ğŸ“Š Security Scan Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, web-app-scan, security-config-check]
    if: always()
    
    steps:
      - name: Download all security artifacts
        uses: actions/download-artifact@v4
        with:
          path: security-artifacts

      - name: Generate security summary
        run: |
          echo "# ğŸ›¡ï¸ Zinses-Rechner å®‰å…¨æ‰«ææŠ¥å‘Š" > security-summary.md
          echo "" >> security-summary.md
          echo "**æ‰«ææ—¶é—´**: $(date)" >> security-summary.md
          echo "**æ‰«æç±»å‹**: ${{ github.event.inputs.scan_type || 'scheduled' }}" >> security-summary.md
          echo "**ç›®æ ‡ç¯å¢ƒ**: ${{ github.event.inputs.target_environment || 'production' }}" >> security-summary.md
          echo "" >> security-summary.md
          
          echo "## æ‰«æç»“æœæ‘˜è¦" >> security-summary.md
          echo "- ä¾èµ–æ¼æ´æ‰«æ: ${{ needs.dependency-scan.result }}" >> security-summary.md
          echo "- Webåº”ç”¨æ‰«æ: ${{ needs.web-app-scan.result }}" >> security-summary.md
          echo "- å®‰å…¨é…ç½®æ£€æŸ¥: ${{ needs.security-config-check.result }}" >> security-summary.md
          echo "" >> security-summary.md
          
          echo "## å®‰å…¨çŠ¶æ€" >> security-summary.md
          if [ "${{ needs.dependency-scan.result }}" = "success" ] && 
             [ "${{ needs.web-app-scan.result }}" = "success" ] && 
             [ "${{ needs.security-config-check.result }}" = "success" ]; then
            echo "ğŸŸ¢ **æ•´ä½“å®‰å…¨çŠ¶æ€: è‰¯å¥½**" >> security-summary.md
            echo "" >> security-summary.md
            echo "æ‰€æœ‰å®‰å…¨æ£€æŸ¥é€šè¿‡ï¼Œç³»ç»Ÿå®‰å…¨é…ç½®æ­£ç¡®ã€‚" >> security-summary.md
          else
            echo "ğŸ”´ **æ•´ä½“å®‰å…¨çŠ¶æ€: éœ€è¦å…³æ³¨**" >> security-summary.md
            echo "" >> security-summary.md
            echo "å‘ç°å®‰å…¨é—®é¢˜ï¼Œè¯·ç«‹å³æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Šå¹¶ä¿®å¤ã€‚" >> security-summary.md
          fi
          
          echo "" >> security-summary.md
          echo "## è¯¦ç»†æŠ¥å‘Š" >> security-summary.md
          echo "- ä¾èµ–æ‰«æ: dependency-scan-reports" >> security-summary.md
          echo "- ZAPæ‰«æ: zap-scan-reports" >> security-summary.md
          echo "- å®‰å…¨é…ç½®: è§å·¥ä½œæµæ—¥å¿—" >> security-summary.md
          
          echo "" >> security-summary.md
          echo "## å»ºè®®è¡ŒåŠ¨" >> security-summary.md
          echo "1. ä¿®å¤æ‰€æœ‰é«˜å±å’Œä¸¥é‡æ¼æ´" >> security-summary.md
          echo "2. æ›´æ–°ä¾èµ–åŒ…åˆ°æœ€æ–°å®‰å…¨ç‰ˆæœ¬" >> security-summary.md
          echo "3. å®šæœŸè¿è¡Œå®‰å…¨æ‰«æ" >> security-summary.md
          echo "4. ç›‘æ§å®‰å…¨å‘Šè­¦å’Œäº‹ä»¶" >> security-summary.md

      - name: Upload security summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary
          path: security-summary.md

      - name: Comment PR with security results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('security-summary.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

  # å®‰å…¨å‘Šè­¦
  security-alerts:
    name: ğŸš¨ Security Alerts
    runs-on: ubuntu-latest
    needs: [dependency-scan, web-app-scan]
    if: failure()
    
    steps:
      - name: Send security alert notification
        run: |
          echo "ğŸš¨ å®‰å…¨æ‰«æå‘ç°ä¸¥é‡é—®é¢˜ï¼"
          
          # å‘é€Slacké€šçŸ¥
          if [ -n "${{ secrets.SLACK_SECURITY_WEBHOOK }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{
                "text": "ğŸš¨ Zinses-Rechner å®‰å…¨æ‰«æå‘Šè­¦",
                "attachments": [
                  {
                    "color": "danger",
                    "fields": [
                      {
                        "title": "æ‰«æç±»å‹",
                        "value": "${{ github.event.inputs.scan_type || 'scheduled' }}",
                        "short": true
                      },
                      {
                        "title": "ç¯å¢ƒ",
                        "value": "${{ github.event.inputs.target_environment || 'production' }}",
                        "short": true
                      },
                      {
                        "title": "åˆ†æ”¯",
                        "value": "${{ github.ref_name }}",
                        "short": true
                      }
                    ],
                    "footer": "å®‰å…¨æ‰«æç³»ç»Ÿ",
                    "ts": '${{ github.event.head_commit.timestamp }}'
                  }
                ]
              }' \
              ${{ secrets.SLACK_SECURITY_WEBHOOK }}
          fi
