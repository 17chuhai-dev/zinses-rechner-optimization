# éƒ¨ç½²å·¥ä½œæµ
# ä¸“é—¨ç”¨äºéƒ¨ç½²åˆ°ä¸åŒç¯å¢ƒçš„GitHub Actionså·¥ä½œæµ

name: Deploy

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      version:
        description: 'Version to deploy (leave empty for latest)'
        required: false
        type: string
      skip_tests:
        description: 'Skip pre-deployment tests'
        required: false
        default: false
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ================================
  # éƒ¨ç½²å‰æ£€æŸ¥
  # ================================
  pre-deployment-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    
    outputs:
      deploy-staging: ${{ steps.check.outputs.deploy-staging }}
      deploy-production: ${{ steps.check.outputs.deploy-production }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine deployment targets
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ github.event.inputs.environment }}" == "staging" ]]; then
              echo "deploy-staging=true" >> $GITHUB_OUTPUT
              echo "deploy-production=false" >> $GITHUB_OUTPUT
            else
              echo "deploy-staging=false" >> $GITHUB_OUTPUT
              echo "deploy-production=true" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "deploy-staging=true" >> $GITHUB_OUTPUT
            echo "deploy-production=false" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "deploy-staging=false" >> $GITHUB_OUTPUT
            echo "deploy-production=true" >> $GITHUB_OUTPUT
          else
            echo "deploy-staging=false" >> $GITHUB_OUTPUT
            echo "deploy-production=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine version
        id: version
        run: |
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=latest" >> $GITHUB_OUTPUT
          fi

      - name: Verify image exists
        run: |
          docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}

  # ================================
  # éƒ¨ç½²å‰æµ‹è¯•
  # ================================
  pre-deployment-tests:
    name: Pre-deployment Tests
    runs-on: ubuntu-latest
    needs: pre-deployment-checks
    if: github.event.inputs.skip_tests != 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run smoke tests against image
        run: |
          docker run --rm -d -p 8080:80 --name test-container \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.pre-deployment-checks.outputs.version }}
          
          # ç­‰å¾…å®¹å™¨å¯åŠ¨
          sleep 10
          
          # è¿è¡Œå¥åº·æ£€æŸ¥
          curl -f http://localhost:8080/health || exit 1
          
          # æ£€æŸ¥ä¸»é¡µ
          curl -f http://localhost:8080/ || exit 1
          
          # æ¸…ç†
          docker stop test-container

  # ================================
  # éƒ¨ç½²åˆ°Stagingç¯å¢ƒ
  # ================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, pre-deployment-tests]
    if: always() && needs.pre-deployment-checks.outputs.deploy-staging == 'true' && (needs.pre-deployment-tests.result == 'success' || needs.pre-deployment-tests.result == 'skipped')
    environment: 
      name: staging
      url: https://staging.zinses-rechner.de
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig

      - name: Deploy to Kubernetes
        run: |
          # æ›´æ–°éƒ¨ç½²é…ç½®ä¸­çš„é•œåƒæ ‡ç­¾
          sed -i "s|IMAGE_TAG|${{ needs.pre-deployment-checks.outputs.version }}|g" k8s/staging/deployment.yaml
          
          # åº”ç”¨é…ç½®
          kubectl apply -f k8s/staging/
          
          # ç­‰å¾…éƒ¨ç½²å®Œæˆ
          kubectl rollout status deployment/zinses-rechner-frontend -n staging --timeout=300s

      - name: Run post-deployment tests
        run: |
          # ç­‰å¾…æœåŠ¡å°±ç»ª
          sleep 30
          
          # è¿è¡Œå¥åº·æ£€æŸ¥
          curl -f https://staging.zinses-rechner.de/health
          
          # è¿è¡ŒåŸºæœ¬åŠŸèƒ½æµ‹è¯•
          npm run test:staging

      - name: Notify deployment success
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          message: |
            âœ… Staging deployment successful!
            Version: ${{ needs.pre-deployment-checks.outputs.version }}
            URL: https://staging.zinses-rechner.de
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # ================================
  # éƒ¨ç½²åˆ°Productionç¯å¢ƒ
  # ================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deployment-checks, pre-deployment-tests]
    if: always() && needs.pre-deployment-checks.outputs.deploy-production == 'true' && (needs.pre-deployment-tests.result == 'success' || needs.pre-deployment-tests.result == 'skipped')
    environment: 
      name: production
      url: https://zinses-rechner.de
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBE_CONFIG_PRODUCTION }}" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig

      - name: Create backup
        run: |
          # å¤‡ä»½å½“å‰éƒ¨ç½²
          kubectl get deployment zinses-rechner-frontend -n production -o yaml > backup-deployment.yaml
          
          # ä¸Šä¼ å¤‡ä»½åˆ°S3æˆ–å…¶ä»–å­˜å‚¨
          # aws s3 cp backup-deployment.yaml s3://backups/deployments/$(date +%Y%m%d-%H%M%S)-deployment.yaml

      - name: Deploy to Kubernetes (Blue-Green)
        run: |
          # æ›´æ–°éƒ¨ç½²é…ç½®
          sed -i "s|IMAGE_TAG|${{ needs.pre-deployment-checks.outputs.version }}|g" k8s/production/deployment.yaml
          
          # åˆ›å»ºæ–°çš„éƒ¨ç½²ï¼ˆGreenï¼‰
          kubectl apply -f k8s/production/deployment-green.yaml
          
          # ç­‰å¾…Greenéƒ¨ç½²å°±ç»ª
          kubectl rollout status deployment/zinses-rechner-frontend-green -n production --timeout=600s
          
          # è¿è¡Œç”Ÿäº§å‰æµ‹è¯•
          kubectl port-forward service/zinses-rechner-frontend-green 8080:80 -n production &
          sleep 10
          curl -f http://localhost:8080/health
          pkill -f "kubectl port-forward"
          
          # åˆ‡æ¢æµé‡åˆ°Green
          kubectl patch service zinses-rechner-frontend -n production -p '{"spec":{"selector":{"version":"green"}}}'
          
          # ç­‰å¾…ç¡®è®¤
          sleep 60
          
          # åˆ é™¤Blueéƒ¨ç½²
          kubectl delete deployment zinses-rechner-frontend-blue -n production --ignore-not-found=true
          
          # é‡å‘½åGreenä¸ºä¸»éƒ¨ç½²
          kubectl patch deployment zinses-rechner-frontend-green -n production -p '{"metadata":{"name":"zinses-rechner-frontend"}}'

      - name: Run post-deployment tests
        run: |
          # ç­‰å¾…DNSä¼ æ’­
          sleep 60
          
          # è¿è¡Œå®Œæ•´çš„ç”Ÿäº§æµ‹è¯•å¥—ä»¶
          npm run test:production
          
          # è¿è¡Œæ€§èƒ½æµ‹è¯•
          npm run test:performance:production

      - name: Update monitoring
        run: |
          # æ›´æ–°ç›‘æ§é…ç½®
          curl -X POST "${{ secrets.GRAFANA_WEBHOOK }}" \
            -H "Content-Type: application/json" \
            -d '{"version": "${{ needs.pre-deployment-checks.outputs.version }}", "environment": "production"}'

      - name: Create GitHub release
        if: startsWith(github.ref, 'refs/tags/')
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.pre-deployment-checks.outputs.version }}
          release_name: Release ${{ needs.pre-deployment-checks.outputs.version }}
          body: |
            ## Changes in this Release
            - Automated deployment from ${{ github.sha }}
            - Deployed to production at $(date)
            
            ## Deployment Information
            - Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.pre-deployment-checks.outputs.version }}
            - Environment: Production
            - URL: https://zinses-rechner.de
          draft: false
          prerelease: false

      - name: Notify deployment success
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployments'
          message: |
            ğŸš€ Production deployment successful!
            Version: ${{ needs.pre-deployment-checks.outputs.version }}
            URL: https://zinses-rechner.de
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # ================================
  # éƒ¨ç½²å¤±è´¥å›æ»š
  # ================================
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure')
    
    steps:
      - name: Rollback staging
        if: needs.deploy-staging.result == 'failure'
        run: |
          echo "Rolling back staging deployment..."
          # æ·»åŠ stagingå›æ»šé€»è¾‘

      - name: Rollback production
        if: needs.deploy-production.result == 'failure'
        run: |
          echo "Rolling back production deployment..."
          # æ·»åŠ productionå›æ»šé€»è¾‘

      - name: Notify rollback
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployments'
          message: |
            âš ï¸ Deployment failed and rollback initiated!
            Check the logs for details.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

  # ================================
  # éƒ¨ç½²åæ¸…ç†
  # ================================
  post-deployment-cleanup:
    name: Post-deployment Cleanup
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()
    
    steps:
      - name: Clean up old images
        run: |
          # æ¸…ç†æ—§çš„å®¹å™¨é•œåƒ
          echo "Cleaning up old container images..."

      - name: Update deployment status
        run: |
          # æ›´æ–°éƒ¨ç½²çŠ¶æ€åˆ°å¤–éƒ¨ç³»ç»Ÿ
          echo "Updating deployment status..."
